1
00:00:00,256 --> 00:00:06,400
前面我们看

2
00:00:06,656 --> 00:00:08,704
看到了malloc和free

3
00:00:10,240 --> 00:00:16,384
5v的过程里头我们其实也是看到了一次我只展现一张图片给你看回收

4
00:00:16,640 --> 00:00:17,920
收益快

5
00:00:19,456 --> 00:00:24,320
现在要谈的是如果回收的是相邻的

6
00:00:25,344 --> 00:00:28,416
他是不是该有一个合并的动作呢

7
00:00:29,184 --> 00:00:31,488
作为一个好的设计他应该有

8
00:00:32,512 --> 00:00:34,304
如果他们没有的话

9
00:00:34,560 --> 00:00:36,352
那么你这些区块

10
00:00:37,376 --> 00:00:40,960
一个一个的被切出去之后将来回不到他

11
00:00:41,472 --> 00:00:43,264
他没把变得比较大

12
00:00:43,520 --> 00:00:48,384
所以整个系统就会越来越脆味越细碎

13
00:00:49,408 --> 00:00:52,736
这不他就变得没有办法应付一个稍微大一点

14
00:00:53,248 --> 00:00:55,552
那个情况会越来越恶化

15
00:00:56,832 --> 00:01:01,440
所以你理想中当然应该要有合并动作

16
00:01:01,696 --> 00:01:02,976
看这一页

17
00:01:06,048 --> 00:01:07,584
这个合并动作

18
00:01:07,840 --> 00:01:09,120
现在这些

19
00:01:09,632 --> 00:01:11,168
为什么会

20
00:01:11,680 --> 00:01:13,728
他当初是相连的

21
00:01:15,008 --> 00:01:15,776
所以

22
00:01:16,032 --> 00:01:22,176
可能是向上合并也可能向下合并要看看当时的状态比如说

23
00:01:23,200 --> 00:01:23,968
现在

24
00:01:24,224 --> 00:01:26,016
要还的是这块

25
00:01:27,552 --> 00:01:29,856
这个有有方格子的这个东西

26
00:01:30,368 --> 00:01:33,952
现在是3011表示给出去

27
00:01:35,232 --> 00:01:41,376
最后的水现在要还回来回收回来这个4301长度其实是300

28
00:01:42,144 --> 00:01:47,520
而目前的状态的上下是白色的我用白色表示

29
00:01:48,032 --> 00:01:49,056
已经收回来了

30
00:01:50,336 --> 00:01:54,176
这样就一会所以这一块即将变成白色

31
00:01:55,200 --> 00:02:00,832
它白色它白色它白色这三块应该要合并起来

32
00:02:01,600 --> 00:02:03,136
我们来看看它怎么合并

33
00:02:04,928 --> 00:02:11,072
上面花白色表示最后一个地址必须是0 300300下面这个也是300

34
00:02:11,328 --> 00:02:12,096
300

35
00:02:13,632 --> 00:02:14,912
我给你这张图

36
00:02:16,192 --> 00:02:21,312
也不是刻意的就让这三块变得一样吧

37
00:02:21,568 --> 00:02:24,384
其实任意大小都可以无所谓

38
00:02:26,688 --> 00:02:30,528
而不是由于我现在刚好吃

39
00:02:30,784 --> 00:02:31,808
样大

40
00:02:32,064 --> 00:02:33,856
所以这两块

41
00:02:34,624 --> 00:02:40,768
3005前的状态是已经回收了他应该落在哪一条链表

42
00:02:41,024 --> 00:02:41,536
表呢

43
00:02:42,048 --> 00:02:44,864
从此比来算一下了300

44
00:02:45,120 --> 00:02:46,400
除以100

45
00:02:46,912 --> 00:02:47,680
91

46
00:02:47,936 --> 00:02:49,216
他应该落在

47
00:02:49,472 --> 00:02:50,752
某一号链表

48
00:02:51,008 --> 00:02:51,776
最快的

49
00:02:52,544 --> 00:02:55,872
也是300所以应该落在同一号电表上

50
00:02:56,384 --> 00:03:02,528
他们两会应该是属于同一个链表上的东西是不是被像我这样的话这个

51
00:03:03,040 --> 00:03:04,576
这个指向这里

52
00:03:05,856 --> 00:03:07,904
就表示他的下一块是他

53
00:03:08,160 --> 00:03:10,464
他的下一块是他这两个指针

54
00:03:10,720 --> 00:03:12,768
是不是一定这样不一定

55
00:03:14,048 --> 00:03:16,608
我这里是表现这种情况

56
00:03:17,376 --> 00:03:20,960
总之我现在告诉你这两块是在同一个链表上面

57
00:03:21,728 --> 00:03:26,848
是否相邻是否被直接相邻的连接无所谓无所谓

58
00:03:29,152 --> 00:03:30,176
好

59
00:03:30,944 --> 00:03:32,736
要还追坏

60
00:03:33,504 --> 00:03:38,624
就必须去判断下面是不是白的以及上面是不是白的

61
00:03:40,416 --> 00:03:44,512
这就要谈到为什么要有上下两块国际

62
00:03:47,072 --> 00:03:52,960
直观的去想cookie是记录整个block整个内存块的大小

63
00:03:54,240 --> 00:03:57,568
那么按照道理讲应该是上面有一个就好了

64
00:03:58,592 --> 00:04:03,968
为什么要下面这个呢而且下面这个又总是跟上面相同的不是累赘吗

65
00:04:05,248 --> 00:04:06,784
好我们看是怎么合并

66
00:04:07,552 --> 00:04:12,928
它的作用才会出现这是一个很有名的人设计出来的一个一个做法

67
00:04:13,440 --> 00:04:19,583
很小的也可以说它是一个高贵的算法

68
00:04:19,839 --> 00:04:23,423
老婆任人民总是记不清楚真抱歉我

69
00:04:23,679 --> 00:04:25,727
很有理所以在这个

70
00:04:26,495 --> 00:04:27,519
在以前

71
00:04:29,055 --> 00:04:30,079
早期

72
00:04:30,335 --> 00:04:36,479
那是什么时候啊2 200203左右

73
00:04:36,735 --> 00:04:38,783
我有我有投稿一篇文章

74
00:04:39,551 --> 00:04:45,695
当时在观察的是vc6跟oranssi家5.0还有人UC

75
00:04:45,951 --> 00:04:51,583
2.9版国际的是我在CSDN上面那个程序员杂志上面

76
00:04:52,351 --> 00:04:53,887
当时去观察呢

77
00:04:55,167 --> 00:05:01,311
就看到波浪cplusplus宝蓝不认识家家他没有下面这个估计

78
00:05:02,079 --> 00:05:04,127
只有VC跟个西游

79
00:05:05,663 --> 00:05:07,967
他缺的效果比他会带来

80
00:05:08,479 --> 00:05:09,759
一个破坏性影响

81
00:05:10,783 --> 00:05:12,831
我们先回到这边技术的探讨

82
00:05:14,111 --> 00:05:15,903
说要还10块

83
00:05:18,463 --> 00:05:24,607
首先往下看能不能合并这个回收是很简单的我们前面已经有的动作看到货

84
00:05:24,863 --> 00:05:25,631
回收了

85
00:05:26,143 --> 00:05:27,935
把这个设为0就回收了

86
00:05:28,703 --> 00:05:29,983
最后的Pizza video

87
00:05:30,495 --> 00:05:32,543
设为零之后看看下面

88
00:05:32,799 --> 00:05:34,847
要怎么往下看呢

89
00:05:37,407 --> 00:05:40,479
我要看我这个地方

90
00:05:41,759 --> 00:05:42,783
这个指针

91
00:05:43,807 --> 00:05:45,087
晚上调整

92
00:05:46,367 --> 00:05:47,647
就是自己这个国家

93
00:05:51,743 --> 00:05:54,047
知道他的长度就是300

94
00:05:54,815 --> 00:05:57,631
再次啊这个晚上

95
00:05:57,887 --> 00:06:00,959
再加300再来了吗

96
00:06:02,495 --> 00:06:04,287
到了这里

97
00:06:04,543 --> 00:06:05,567
我们知道

98
00:06:05,823 --> 00:06:08,127
就是下一块的固体

99
00:06:09,919 --> 00:06:13,503
就可以看出来下一块最后一个病人是不是零

100
00:06:14,527 --> 00:06:18,111
现在是0表示我可以跟下面合并

101
00:06:19,391 --> 00:06:20,415
我再讲一次

102
00:06:20,671 --> 00:06:21,695
现在这里

103
00:06:21,951 --> 00:06:24,767
哪个更细的东西呢

104
00:06:25,279 --> 00:06:26,559
现在这里

105
00:06:27,839 --> 00:06:29,119
而且这里

106
00:06:29,375 --> 00:06:31,167
打开一看这个

107
00:06:31,423 --> 00:06:35,007
弓箭的地方网上四个字节

108
00:06:35,519 --> 00:06:36,799
抓到的长度

109
00:06:37,823 --> 00:06:39,615
加上这个长度

110
00:06:40,127 --> 00:06:42,431
就落在下一会的起点

111
00:06:43,967 --> 00:06:46,527
好我们知道下一块一开始就是古迹

112
00:06:46,783 --> 00:06:50,879
所以就能够去检查最后一个地址是不是你

113
00:06:52,159 --> 00:06:53,439
目前是美

114
00:06:54,207 --> 00:06:56,255
所以这两块可以合并

115
00:06:57,535 --> 00:07:00,351
怎么合并呢右边这样

116
00:07:00,607 --> 00:07:02,655
它的长度就是600的

117
00:07:03,935 --> 00:07:07,263
两个相加600

118
00:07:07,519 --> 00:07:13,663
这时候应该可以把这个cookie全进去这个直流呢

119
00:07:13,919 --> 00:07:16,735
500钱进去可是我写的是问号

120
00:07:17,503 --> 00:07:18,271
因为

121
00:07:19,807 --> 00:07:21,855
自杀缪程还没有结束

122
00:07:22,367 --> 00:07:23,903
还要在网上看

123
00:07:25,439 --> 00:07:26,463
他是这时候

124
00:07:27,487 --> 00:07:28,767
指针刚刚

125
00:07:29,279 --> 00:07:31,071
描述指针在这里

126
00:07:31,839 --> 00:07:33,887
黑网上看四个字节

127
00:07:34,399 --> 00:07:35,679
上面那一块呢

128
00:07:37,471 --> 00:07:43,615
由于目前的设计所以我们知道如果在网上四个字节就是上

129
00:07:43,871 --> 00:07:44,639
放一会

130
00:07:48,735 --> 00:07:54,367
如果没有这个下cookie的话我们不知道上一块的估计在哪里

131
00:07:56,671 --> 00:07:59,231
大家一次这个指针还的是这里

132
00:08:00,255 --> 00:08:02,815
网上是个自己到这里来

133
00:08:04,095 --> 00:08:10,239
由于目前的设计所以我们知道在网上四个字节就可以看到上一会

134
00:08:10,495 --> 00:08:11,007
会的

135
00:08:11,263 --> 00:08:12,031
下

136
00:08:13,311 --> 00:08:15,103
我看到了最后一个的城市里

137
00:08:16,383 --> 00:08:19,967
也知道长度了所以我还可以再往上调300

138
00:08:20,735 --> 00:08:22,271
指针就跳到这里了

139
00:08:23,551 --> 00:08:24,319
就可以

140
00:08:24,831 --> 00:08:29,439
把这个上下再合并成为右边这样就是900

141
00:08:31,743 --> 00:08:35,071
所以如果没有下cookie这个设计

142
00:08:35,839 --> 00:08:38,655
就没有办法往上合并

143
00:09:09,631 --> 00:09:11,679
开挂的那个链表去

144
00:09:12,703 --> 00:09:14,751
这就是合并的动作

145
00:09:18,847 --> 00:09:24,991
很重要的没有这个合并的动作的话这个整个分配跟释放的机制

146
00:09:25,247 --> 00:09:29,855
少了一个方向的合并

147
00:09:34,463 --> 00:09:37,791
很有趣

148
00:09:38,815 --> 00:09:41,887
计算机科学家能想出了一个下库

149
00:09:42,143 --> 00:09:45,727
就解决了很快的很好的解决了这个问题

150
00:09:47,519 --> 00:09:48,543
没有谈到

151
00:09:48,799 --> 00:09:49,823
我们前面谈

152
00:09:50,335 --> 00:09:53,407
这一讲个太强没了我再讲

153
00:09:53,663 --> 00:09:59,807
这每一个被malloc分配出去的区块都带着上下股票的八个

154
00:10:00,063 --> 00:10:00,831
那个自己

155
00:10:02,111 --> 00:10:06,207
Overhead如果太小不可避免

156
00:10:06,463 --> 00:10:07,487
外开销

157
00:10:09,023 --> 00:10:15,167
所以在第2项里头相似的三角三第2讲里面我们谈的那个分配器有多个那个

158
00:10:15,423 --> 00:10:18,751
那个分配器很棒他就是想去除这个国家

159
00:10:20,031 --> 00:10:23,871
每一个区块可以少掉八个字节这是蛮好的
